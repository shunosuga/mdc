# スコア改善分析: 0.563 → 0.591

## 概要

このドキュメントでは、Make Data Countコンペティションにおいて、F1スコアが0.563から0.591に向上した要因について詳細に分析します。両解法の共通部分と、スコア向上につながった具体的な変更点を特定しました。

## 共通アーキテクチャ

両解法は以下の共通パイプライン構造を採用しています：

### 1. 環境構築
- `uv pip install`を使用した依存関係の管理
- TensorFlowの削除とvLLM関連ライブラリのインストール

### 2. ヘルパー機能 (`helpers.py`)
- ログ設定とパス管理
- 文字列正規化とデータ処理ユーティリティ
- 評価関数（F1スコア計算）

### 3. PDFパース (`parse.py`)
- PyMuPDFを使用したPDFテキスト抽出
- XMLファイルの追加処理（0.591でlxml対応強化）

### 4. パース品質チェック (`check_parse.py`)
- パース結果の検証
- 訓練ラベルとの照合

### 5. ID抽出 (`getid.py`)
- 正規表現を使用したデータセットID検出
- 文脈ウィンドウの構築
- 参考文献セクションの分離

### 6. LLM検証 (`llm_validate.py`)
- Qwen 32B AWQモデルを使用
- DOIの分類（データ vs 文献）
- 構造化プロンプトとlogits制約

### 7. ポストフィルタリング (`post_filter.py`)
- 偽陽性の除去
- 出版社プレフィックスに基づくフィルタリング

## 主要な違いとスコア向上要因

### 1. 依存関係の改善

**0.563 → 0.591での変更:**
- **追加**: `lxml`ライブラリ → XMLパース能力の向上
- **更新**: `logits-processor-zoo` 0.1.12 → 0.2.1 → LLM出力の一貫性向上

### 2. 正規表現パターンの最適化（最重要）

#### 削除されたパターン
```python
# 0.563で含まれていたが0.591で削除
"PRJEB\d+"  # European Nucleotide Archive (ENA) プロジェクト
"SR[PRX]"   # 0.591では"SR[PX]"に変更（SRRパターンを除去）
```

#### 追加されたパターン
```python
# 0.591で新規追加
"CVCL_[A-Z0-9]{4}"  # Cellosaurus細胞株データベース
```

### 3. スコア向上の詳細分析

#### 偽陽性の削減戦略

**PRJEB除去の効果:**
- PRJEBアクセッション（European Nucleotide Archive）は、訓練データにおいて文献引用として扱われているケースが多かった
- これらを除去することで偽陽性が大幅に減少

**SRRパターン除去の効果:**
- `SR[PRX]` → `SR[PX]`の変更により、SRR（Sequence Read Archive）アクセッションが除外
- SRRは個別のシーケンスリードファイルを指すため、データセット全体を表さない場合が多い
- より適切なSRP（プロジェクト）やSRX（実験）レベルのアクセッションのみを対象とする戦略

#### 真陽性の向上戦略

**CVCL追加の効果:**
- 細胞株データベース（Cellosaurus）のアクセッションを新たに検出
- 生物医学研究において重要なデータタイプを補完
- 訓練データに含まれていた細胞株データへの対応を改善

### 4. F1スコア改善のメカニズム

**精度（Precision）の向上:**
- 偽陽性パターン（PRJEB、SRR）の除去により、間違って検出されるIDが減少
- より信頼性の高いパターンのみを対象とすることで精度が向上

**再現率（Recall）の向上:**
- CVCLパターンの追加により、従来検出できなかった細胞株データを捕捉
- lxml対応によるXMLパース品質向上で、テキスト抽出精度が改善

**バランスの最適化:**
- F1スコア = 2 × (精度 × 再現率) / (精度 + 再現率)
- 精度と再現率の両方を改善することで、F1スコアの効果的な向上を実現

## 技術的洞察

### 1. データセット特性の理解
- コンペティションの訓練データには、特定のアクセッションタイプ（PRJEB、SRR）が「データ」ではなく「文献」として分類されている傾向
- この特性を理解し、パターンを調整することが重要

### 2. 段階的最適化の重要性
- 大幅な変更ではなく、細かなパターン調整による改善
- 各変更の影響を理解した上での戦略的アプローチ

### 3. バイオインフォマティクス知識の活用
- NCBI/ENAデータベースの階層構造理解
- プロジェクト（SRP）vs 実験（SRX）vs リード（SRR）の区別
- 細胞株データベース（CVCL）の重要性認識

## 今後の改善提案

### 1. さらなるパターン精密化
- 他のデータベースアクセッション（EMDB、PDBなど）の詳細分析
- 文脈に依存するパターンの条件付き適用

### 2. LLMプロンプトの最適化
- データタイプ別の分類精度向上
- Few-shotサンプルの質的改善

### 3. アンサンブル手法の導入
- 複数のパターン抽出手法の組み合わせ
- 信頼度スコアに基づく重み付け

## 結論

0.563から0.591への28ポイント（+4.97%）のF1スコア向上は、主に正規表現パターンの戦略的調整によって実現されました。特に：

1. **偽陽性削減**: PRJEB、SRRパターンの除去
2. **真陽性向上**: CVCLパターンの追加  
3. **技術的改善**: lxml対応とlogits-processor-zoo更新

この分析は、データサイエンスコンペティションにおいて、ドメイン知識に基づく細かな調整が大きな効果をもたらすことを示しています。